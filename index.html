<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>KIFT</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <br>
  <button class="alarm-start">Animate</button>
  <div class="bar-grow">
    <div class="left-side">
      <h1 class="left-minute">2</h1>
      <h1 class="left-second">3</h1>
    </div>
    <div class="right-side">
      <h1 class="right-minute">4</h1>
      <h1 class="right-second">7</h1>
    </div>
  </div>
  <p id="notification" style="display: none"></p>
  <div class="user-field">
    <form id="users" action="" method="POST">
      <input type="text" id="username" placeholder="Username" name="username" value="" required>
      <input type="text" id="location" placeholder="Location" name="location" value="" required>
      <br><br>
      <button type="submit" id="connect">Connect</button>
    </form>
  </div>

  <div class="left">
    <button id="startButton" class="button">
      Record
    </button>
    <p2 class="prev">Listen</p2>
    <audio id="preview" autoplay muted></audio>
  </div>
  <div class="right">
    <audio id="recording" controls></audio>
  </div>
  <div class="bottom">
    <pre id="log"></pre>
  </div>
  <button id="serv">Server Test</button>
  <div class="scroll-box">
    <ul id="response"></ul>
  </div>
  </form>
</head>

<body>
  <script>
    let connectButton = document.querySelector('#connect')
    $("#users").submit(function (e){
      e.preventDefault();
      let username = $("#username").val();
      let locations = $("#location").val();
      $.ajax({
        url: "http://localhost:3000/users",
        type: "POST",
        data: JSON.stringify({
          "username": username,
          "location": locations
        }),
        contentType: "application/json",
        success: function (response) {
          alert("Successfully connected to server")
          $("#users").hide()
        },
        error: function(error) {
          alert("Error during connection")
        }
      })
    })
  </script>
  <script>
    let preview = document.getElementById("preview");
    let recording = document.getElementById("recording");
    let startButton = document.getElementById("startButton");
    let stopButton = document.getElementById("stopButton");
    let loginButton = document.querySelector("#login");
    let lastButton = document.querySelector("#last");
    let firstButton = document.querySelector("#first");
    let submit = document.querySelector("#submit");
    ////////////////////////////////////////////////////////////////
    let alarm_butt = document.querySelector(".alarm-start");      //
    let alarm = document.querySelector(".bar-grow");              //
    let left_side = document.querySelector(".left-side");         //  Alarm Buttons
    let right_side = document.querySelector(".right-side");       //
    ////////////////////////////////////////////////////////////////
    let spotify_butt = document.querySelector(".spotify-button");
    const constraints = {
      audio: {
        sampleRate:16000},
      video: false
    };

    let recordingTimeMS = 4000;

    $(".user-form").submit(function (e) {
      e.preventDefault();
    });
    alarm_butt.onclick = function testAlarm() {
      let time = 32;
      let add = 0;
      console.log("damnn");
      let open = setInterval(animateWidth, 2);

      function animateWidth(time) {
        if (alarm.style.width != "120px") {
          alarm.style.width = add + 'px';
          add++;
        } else {
          clearInterval(open);
          add = 0;
          open = setInterval(animateHeight, 2);

          function animateHeight() {
            if (alarm.style.height != "80px") {
              alarm.style.height = add + 'px';
              add++;
            } else {
              clearInterval(open);
              let reveal = setInterval(showNumber, 30);
              add = 0;

              function showNumber() {
                if (left_side.style.opacity < 0.9 && right_side.style.opacity < 0.9) {
                  left_side.style.opacity = 0 + '.' + add;
                  right_side.style.opacity = 0 + '.' + add;
                  add++;
                } else {
                  clearInterval(reveal);
                }
              }
            }
          }
        }
      }

    }

    
    startButton.addEventListener("click", function () {
      
        $.ajax({
          url: "/command",
          method: "GET",
          success: function (data) {
            console.log(data)
            stringParse(data);

            function stringParse(command) {
              var com_array = command.split(";");
              var command = com_array[0];
              console.log(command);
              console.log(com_array);

              function dispatchComm(comm, content) {
                if (comm == "Alarm") {
                  $(".client-input").show();
                  $("#response").append('<li>' + com_array[1] + '</li>');
                  var alarm_synth = window.speechSynthesis;
                  var alarm_speech = new SpeechSynthesisUtterance("Enter Alarm Time");
                  alarm_speech.lang = 'en-US';
                  alarm_synth.speak(alarm_speech);
                  $(".client-input").on('keyup', function (event) {
                    if (event.keyCode == 13) {
                      user_input = parseInt($(".client-input").val());
                      $(".client-input").val("");
                      if (user_input > 59)
                        user_input = 59;
                      if (isNaN(user_input)) {
                        $("#response").append('<h1 class="error-mess" style="color: red;">' +
                          "ENTER A VALID NUMBER" + '</h1>');
                        setTimeout(function () {
                          let error_txt = document.querySelector("#response");
                          error_txt.removeChild(error_txt.lastChild);
                        }, 2000);
                      }
                      console.log(user_input);
                      //function openAlarm(user_input)
                      //{}
                    }
                  });
                } else if (comm == "Song") {
                  $(".spotify-button").show();
                  $("#response").append('<li>' + "Please Sign In First" + '</li>');
                  var song_synth = window.speechSynthesis;
                  var song_speech = new SpeechSynthesisUtterance("Sign In");
                  song_speech.lang = 'en-US';
                  song_synth.speak(song_speech);
                } else if (comm == "lights") {
                  if (content.substring(0,11).localeCompare(" Turning on") == 0) {
                    $('#image').attr("src", "https://images.cooltext.com/5285731.png")
                  } else {
                      $('#image').attr("src", "logo1.png")
                    }
                } else {
                  console.log("Shirt");
                  $("#response").append('<li>' + com_array[1] + '</li>');
                  var synth = window.speechSynthesis;
                  var test = document.querySelector("#response").lastChild.innerHTML;
                  var speech = new SpeechSynthesisUtterance(com_array[1]);
                  speech.lang = 'en-US';
                  synth.speak(speech);
                }
              }
              dispatchComm(command, com_array[1]);
            }
          },
        });
        })
  </script>
  <script>
    
  </script>
  <style>
    #startButton {
      background-color: blue;
      color: white;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: 10px;
      margin-left: -50px;
    }

    li {
      list-style-type: none;
    }

    #stopButton {
      background-color: red;
      color: white;
    }

    body {
      width: 100vw;
      height: 100vh;
      font-family: "lato", sans-serif;
      color: #E8AFE1;
      background: #ad1283;
      /* Old browsers */
      background: -moz-linear-gradient(-45deg, #ad1283 0%, #8f45d8 100%);
      /* FF3.6-15 */
      background: -webkit-linear-gradient(-45deg, #ad1283 0%, #8f45d8 100%);
      /* Chrome10-25,Safari5.1-6 */
      background: linear-gradient(135deg, #ad1283 0%, #8f45d8 100%);
      /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
      filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ad1283', endColorstr='#8f45d8', GradientType=1);
      /* IE6-9 fallback on horizontal gradient */
    }

    .logo {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 300px;
      height: 300px;
      margin-top: -250px;
      margin-left: -170px;
    }

    .scroll-box {
      height: 150px;
      width: 40vw;
      overflow-y: scroll;
      box-shadow:
        0 15px 30px 0 rgba(0, 0, 0, 0.11),
        0 15px 15px 0 rgba(0, 0, 0, 0.08);
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: 60px;
      margin-left: -290px;
    }

    .prev {
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: 230px;
      margin-left: -30px;
    }

    #recording {
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: 270px;
      margin-left: -150px;
    }

    #startButton {
      width: 40rem;
      padding: .5rem 1rem;
      margin: 0 1rem 1rem;
      background: #5fb3b3;
      border: none;
      border-radius: .5rem;
      color: #ffffff;
      font-size: 1rem;
      font-weight: bold;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: -30px;
      margin-left: -325px;
      z-index: 1;
    }

    #startButton:hover {
      cursor: pointer;
    }

    .user-field {
      height: 100px;
      width: 500px;
      position: absolute;
      left: 32%;
    }

    .user-field input {
      width: 40%;
      height: 2em;
    }

    #connect {
      width: 150px;
      margin: 0 25%;
    }

    #first {
      float: left;
    }

    #last {
      float: right;
    }

    #login {
      position: absolute;
      left: 43%;
    }

    .bar-grow {
      height: 2px;
      width: 1px;
      background-color: red;
      position: absolute;
    }

    .left-side {
      background-color: blue;
      opacity: 0.0;
      height: 100%;
      width: 40%;
      float: left;
      position: relative;
    }

    .right-side {
      background-color: green;
      opacity: 0.0;
      height: 100%;
      width: 40%;
      float: right;
      position: relative;
    }

    .left-minute,
    .right-minute {
      float: left
    }

    .left-second,
    .right-second {
      float: right;
    }

    .client-input {
      height: 30px;
      width: 38vw;
      overflow-y: scroll;
      overflow-x: hidden;
      box-shadow:
        0 15px 30px 0 rgba(0, 0, 0, 0.11),
        0 15px 15px 0 rgba(0, 0, 0, 0.08);
      position: absolute;
      top: 72%;
      left: 51%;
      margin-top: 60px;
      margin-left: -290px;
      border-style: none;
      background-color: #2d2d2d;
      opacity: 0.3;
      font-size: 18px;
      color: white;
      border-radius: 18px;
    }

    .spotify-button {
      top: 72%;
      left: 66%;
      position: absolute;
      margin-top: 60px;
      margin-left: -290px;
    }
  </style>
  <img id="image" class="logo" src="logo1.png">
  <a
    href="https://accounts.spotify.com/authorize?response_type=code&client_id=f137e890f3734bd38fdcf1d980158139&scope=user-read-private%20user-read-email%20user-read-playback-state%20user-modify-playback-state&redirect_uri=http://localhost:3000/oauth">
    <image class="spotify-button" src="Spotify_Logo_RGB_GREEN.png" style="width: auto; height: 35px; display: none;">
    </image>
  </a>
  <textarea class="client-input" style="display: none;"></textarea>
</body>

</html>